From 75ed5cd525be9a749c0a170d6e78fbffc8ebc93d Mon Sep 17 00:00:00 2001
From: Kacper Kornet <draenog@pld-linux.org>
Date: Fri, 10 Jun 2011 16:31:36 +0200
Subject: [PATCH] Run gl-install in gl-setup for only when admin repo was
 created

With large number of repos gl-install is expensive to run. So it should
be run for the second time in gl-setupe only when necessary.
---
 src/gl-setup | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/src/gl-setup b/src/gl-setup
index 1970d93..c7ae927 100755
--- a/src/gl-setup
+++ b/src/gl-setup
@@ -168,6 +168,7 @@ gl-install -q
         repo    testing
                 RW+     =   @all
     " | cut -c9- > $GL_ADMINDIR/conf/gitolite.conf
+   RERUN_GL_INSTALL = 1
 }
 [ -n "$pubkey_file" ] && cp $pubkey_file $GL_ADMINDIR/keydir
 
@@ -186,7 +187,7 @@ gl-compile-conf -q
 
 # now that the admin repo is created, you have to set the hooks properly; best
 # do it by running install again
-gl-install -q
+[ "$RERUN_GL_INSTALL" = 1 ] && gl-install -q
 
 # ----------------------------------------------------------------------
 #   lint check on ssh keys
-- 
1.7.11.rc0

